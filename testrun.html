<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="user-scalable=no,width=device-width" />
	<title>HTML5Reader</title>

	<script src="../events-2.0.js"></script>
	<script src="assets/Resolutions.js"></script>
	<script src="assets/sji.js"></script>
	<script src="assets/customevents.js"></script>
	<script src="assets/linklistener.js"></script>

	<script src="scrapers/yqlhelper.js"></script>
	<script src="scrapers/entry.js"></script>
	<script src="scrapers/comic.js"></script>
	<script src="scrapers/reader.js"></script>
	<script src="scrapers/yqlcomic.js"></script>

	<script src="assets/settings/settings.delicious.bookmarks.js"></script>
	<script src="assets/settings.js"></script>
	<script src="ui/ajaxhelper.js"></script>
	<script src="ui/options.js"></script>
	<script src="ui/auth.js"></script>

	<script type="text/javascript">
		var MenageA3ReaderComic = new nl.windgazer.YQLComic(
			(943<<16) + 1,
			"Menage a 3"
			, "http://www.menagea3.net/"
			, "//div[@id=\"cc\"]//img|//a[@id=\"cndprev\"]|//a[@id=\"cniprev\"]|//a[@id=\"cndnext\"]"
			, {
				/**
				 * Sorting entry url versus link,  if the first one is the link, it's a previous link :)
				 */
				getLinkIsPrev: function( link, jsonData, url, comic ) {
					return jsonData.query.results.a.id && jsonData.query.results.a.id.indexOf("prev") >= 0;
				}
			}
		);
		var GirlGeniusReaderComic = new nl.windgazer.YQLComic(
			(943<<16) + 2,
			"Girl Genius"
			, "http://www.girlgeniusonline.com/comic.php"
			, "//img[@alt=\"Comic\"]|//table[@id=\"MainTable\"]/tr[2]/td[1]//a[2]|//table[@id=\"MainTable\"]/tr[2]/td[1]//a[3]"
			, {
				/**
				 * Sorting entry url versus link,  if the first one is the link, it's a previous link :)
				 */
				getLinkIsPrev: function( link, jsonData, url, comic ) {
					//No request params means latest comic and link is then always to previous...
					if (url.indexOf("?") < 1) return true;
					
					//Else sort current url versus the link...
					var urls = [url, link.href];
					urls.sort();
					
					//if url does not equal the first link after sort, the link is to previous comic...
					var isPrev = url != urls[0];
					return isPrev;
				}
			}
		);

		var PennyArcadeReaderComic = new nl.windgazer.YQLComic(
				(943<<16) + 3,
				"Penny Arcade",
				"http://penny-arcade.com/comic",
				"//div[@class=\"contentArea\"]//img|//ul[@class=\"newsNav top\"]//a[@class=\"btnPrev btn\"]|//ul[@class=\"newsNav top\"]//a[@class=\"btnNext btn\"]",
				{
					getHasNextEntry : function( entry ) {
						Console.log( "Attempting to determine next entry existence for Penny Arcade" );
						Console.log( entry.config["next"] );
						return ( entry.config["next"] && ( entry.config["next"].length - PennyArcadeReaderComic.params["URL"].length ) > 2 );
					}
				}
			);

		function initReader() {
			PennyArcadeReaderComic.fetchLatest(  );
		}
		
		ce.attachEvent( window.ON_AUTH_SUCCESS, initReader);
		ce.attachEvent( window.ON_AUTH_CANCELED, initReader);
		
		ce.attachEvent( nl.windgazer.COMIC_EVENT_ID, function( eid, data ) {
			
			nl.windgazer.Reader.setEntry( data.entry );
			nl.windgazer.Reader.setComic( data.comic );

			document.getElementById("comicImage").src = data.entry.getImgURL();

		} );

		LinkListener.addHandler( "prevEntry", function() {
			var r = nl.windgazer.Reader, c = r.getComic(), e = r.getEntry();
			if ( e.getPrevURL(  ) ) {
				c.fetchByURL ( e.getPrevURL(  ) );
			}
		} );

		LinkListener.addHandler( "nextEntry", function() {
			var r = nl.windgazer.Reader, c = r.getComic(), e = r.getEntry();
			if ( e.getNextURL(  ) ) {
				c.fetchByURL ( e.getNextURL(  ) );
			}
		} );
		
		LinkListener.addHandler( "switchComic", function() {
			var c = nl.windgazer.Reader.getComic();
			if ( c && c.getId() == PennyArcadeReaderComic.getId() ) {
				GirlGeniusReaderComic.fetchLatest(  );
			} else {
				PennyArcadeReaderComic.fetchLatest(  );
			}
		} );
	</script>
	<link type="text/css" rel="stylesheet" href="assets/layout.css" />
</head>
<body>

	<h1>HTML5 Web-Comic Reader, testing shit...</h1>

	<ul id="controls">
		<li><a rel="switchComic" href="#ComicReader">Get Latest Image</a></li>
		<li><a rel="prevEntry" href="#ComicReader">Get Previous Image</a></li>
		<li><a rel="nextEntry" href="#ComicReader">Get Next Image</a></li>
		<li><a rel="overlay" href="#options">&#x3A9;</a></li>
		<li><select id="comicSelector"></select></li>
	</ul>

	<div id="ComicReader"><img src="about:blank" id="comicImage" /></div>

	<div id="options">

		<div class="dialog">

			<h2>Options</h2>

			<form id="debugOptionsForm">
				<fieldset>
					<legend>Landscape</legend>
					<p>These are the settings for displaying images in landscape mode on your device. <em>These settings will not be shared among othe devices that may in the future share your comics settings.</em></p>
					<label class="advanced" for="ls-ls-limit-width">Limit landscape width</label><input id="ls-ls-limit-width" type="checkbox" />
					<label class="advanced" for="ls-ls-force-width">Force landscape width</label><input id="ls-ls-force-width" type="checkbox" />
					<label class="advanced" for="ls-ls-force-height">Force landscape height</label><input id="ls-ls-force-height" type="checkbox" />
					<label for="ls-p-limit-height">Limit portrait height</label><input id="ls-p-limit-height" type="checkbox" />
				</fieldset>
				<fieldset>
					<legend>Portrait</legend>
					<p>These are the settings for displaying images in portrait mode on your device. <em>These settings will not be shared among othe devices that may in the future share your comics settings.</em></p>
					<label for="p-ls-limit-width">Limit landscape width</label><input id="p-ls-limit-width" type="checkbox" />
					<label class="advanced" for="p-p-limit-height">Limit portrait height</label><input id="p-p-limit-height" type="checkbox" />
					<label class="advanced" for="p-p-force-height">Force portrait height</label><input id="p-p-force-height" type="checkbox" />
					<label class="advanced" for="p-p-force-width">Force portrait width</label><input id="p-p-force-width" type="checkbox" />
				</fieldset>
				<fieldset>
					<legend>Online storage</legend>
					<p>Here you may control how and/or where to store which comics you've read last. Be aware that the utmost care has been taken to make this as safe as possible, but such control may be somewhat limited.</p>
					<label for="online-storage">Store last read comics online</label><input id="online-storage" type="checkbox" />
				</fieldset>
				<fieldset>
					<legend>Debugging</legend>
					<p>These settings are for developers use, they should provide you with extra information if you need to file a bug-report or figure out why your own developed comic does not work.</p>
					<label for="debugOption">Debug</label><input id="debugOption" type="checkbox" />
					<label for="advancedOption">Advanced</label><input id="advancedOption" type="checkbox" />
				</fieldset>
			</form>

			<a id="optionsShutdown" class="control" rel="overlayShutdown" href="#ComicReader">Done</a>

		</div>

	</div>

	<div id="auth">

		<div class="dialog">

			<h2>Authenticate</h2>
			
			<form id="authenticationForm" action="#ComicReader">
				<fieldset>
					<p>Authenticate with a Delicious account to store/retrieve your last read comics. If you click 'cancel', such information will be store offline and can't be accessed from another device.</p>
					<label for="auth-uid">Username / E-mail</label><input id="auth-uid" type="text" />
					<label for="auth-pwd">Password</label><input id="auth-pwd" type="password" />
				</fieldset>
			</form>

			<a id="authVerify" class="control" rel="authVerify" href="#authenticationForm">Authenticate</a>

			<a id="authCancel" class="control" rel="authCancel" href="#authenticationForm">Cancel</a>

		</div>

	</div>

</body>
</html>